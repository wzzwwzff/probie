<%@ page import="com.app.cq.en.HouseStatus" %>
<%@ page import="java.util.List" %>
<%@ page import="java.util.Map" %>
<%@ page import="com.app.cq.model.House" %>
<%@ page import="com.app.common.model.DataDict" %>
<%@ page import="java.util.ArrayList" %>
<%@ page import="com.sqds.utils.StringUtils" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="tags" tagdir="/WEB-INF/tags" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<c:set var="ALLOW" value="<%=HouseStatus.ALLOW.getIndex()%>"/>
<c:set var="PRETEND" value="<%=HouseStatus.PRETEND.getIndex()%>"/>
<c:set var="SIGNED" value="<%=HouseStatus.SIGNED.getIndex()%>"/>
<%
    int max = (Integer) request.getAttribute("maxFloor");
    List<String> unitList = (List<String>) request.getAttribute("unitList");
    Map<String, String> maxRoomByUnit = (Map<String, String>) request.getAttribute("maxRoomByUnitMap");
    Map<String, House> houseMap = (Map<String, House>) request.getAttribute("houseMap");
    Map<String, DataDict> flagMap = (Map<String, DataDict>) request.getAttribute("flagMap");
    Map<String, Map<String, String>> houseTypeMap = (Map<String, Map<String, String>>) request.getAttribute("houseTypeMap");
    Map<String, String> houseTypeDataDictMap = (Map<String, String>) request.getAttribute("houseTypeDataDictMap");
    Map<String, String> typeMap = (Map<String, String>) request.getAttribute("typeMap");
    int column = 0;
%>
<div style="text-align: center;width: 99%;margin-top: 10px;" id="content">
<c:if test="${maxFloor ne 0}">
    <span style="color: black;font-size: 18px;">图例：</span>

    <c:forEach items="${flagMap}" var="flag">
        <%--<c:if test="${flag.key ne PRETEND}">--%>
        <button class="button btn button-circle" style="background-color: ${flag.value.attributeColor};margin-bottom: 10px;width: 20px;height: 20px;"></button>
        <span style="color: ${flag.value.attributeColor};font-size: 18px;">${flag.value.attributeName}</span>
        <%--</c:if>--%>
    </c:forEach>
    <%--<button class="btn btn-primary btn-sm" id="excelBtn"><i class="fa fa-file-excel-o"></i>&nbsp;导出Excel</button><br/>--%>
    <br/><br/>
    <%
        if (max != 0) {
    %>
    <table  id="dataTable" width="100%" border="1" align="center" cellpadding="1" cellspacing="1" bgcolor="#999999">
        <%

            String temp = max + "";
            int maxFloorNum = max; //最大层高
            int[] setNum1 = new int[unitList.size()];

            List temp1 = new ArrayList();
            for (String s : unitList) {
                temp1.add(s);
            }
        %>
        <tr>
            <td width="4%" height="35" bgcolor="#cccccc" align="center"><b>户型</b></td>
            <%
                int s = 0;
                for (int ii = temp1.size() - 1; ii >= 0; ii--) {
//                for (int ii = 0; ii < temp1.size(); ii++) {
                    String si = (String) temp1.get(ii);
                    int maxSetNum = 0;

                    String roomCode = (String) maxRoomByUnit.get(si);
                    if (roomCode == null) {
                        setNum1[s] = 0;
                        s++;
                        continue;
                    }
                    temp = roomCode.substring(roomCode.length() - 2);
                    maxSetNum = Integer.parseInt(temp);


                    for (int j = 0; j < maxSetNum; j++) {
//                     for (int j = maxSetNum - 1; j >= 0; j--) {
                        String prefix = "0" + (j + 1);
                        prefix = prefix.substring(prefix.length() - 2);

                        Map<String,String> baseInfo = houseTypeMap.get(si);
                        String info = "";
                        String dataDict = baseInfo.get(prefix);//居室/套型
                        if(dataDict != null){
                            String js = houseTypeDataDictMap.get(dataDict);
                            info = "<b>" + js + "</b>";
                        }

            %>
            <td bgcolor="#cccccc" align="center"
                <%if(j==maxSetNum-1){%>style="border-left:#999999 3px solid;"<%}%>>
                <%=info%>
            </td>
            <% }
            }%>
        </tr>

        <%
            for (int i = maxFloorNum; i > 0; i--) { %>
        <tr bgcolor="#FFFFFF">
            <td width="4%" height="18" bgcolor="#D6D3D6">
                <div align="center"><%=i%>
                </div>
            </td>
            <%
                String floorStr = "0" + i;
                if (floorStr.length() > 2) {
                    floorStr = floorStr.substring(1); //层
                }
                s = 0;
                for (int ii = temp1.size() - 1; ii >= 0; ii--) {
//                for (int ii = 0; ii < temp1.size(); ii++) {
                    String si = (String) temp1.get(ii);
                    int maxSetNum = 0;

                    String roomCode = (String) maxRoomByUnit.get(si);
                    if (roomCode == null) {
                        setNum1[s] = 0;
                        s++;
                        continue;
                    }

                    temp = roomCode.substring(roomCode.length() - 2);
                    maxSetNum = Integer.parseInt(temp);
                    setNum1[s] = maxSetNum;

                    if (i == 1) {
                        column += maxSetNum;
                    }
                    for (int j = 0; j < maxSetNum; j++) {
//                    for (int j = maxSetNum - 1; j >= 0; j--) { {
                        String roomNum = "0" + (j + 1);
                        if (roomNum.length() > 2) {
                            roomNum = roomNum.substring(roomNum.length() - 2, roomNum.length());
                        }
                        String room1 = floorStr + roomNum;
                        String bgColor = "#ffffff";


                        House house = (House) houseMap.get(si + "-" + room1);
                        String roomNum1 = "";
                        String area = "";
                        String showInfo = "";
                        String click = "";   // 点击事件
                        String cursor = "";
                        String str2 = "";
                        if (house != null) {
                            area = StringUtils.getNotNullDecimal(house.getBuildArea());
                            if (!area.equals("") && !area.equals("0")) {
                                area = area + "㎡";
                            }
//                            roomNum1 = house.getMemo();
                            String dataDict = houseTypeDataDictMap.get(house.getHouseType() + "");//居室/套型
                            if (dataDict != null) {
//                                str2 = dataDict.getAttributeName();
                            }
                            showInfo ="<font style='font-size:20px;'>" +house.getHouseNum()+"</font></br>";
                            if (!area.equals("") && !area.equals("0.00㎡")) {
                                showInfo += "<font style='font-size:17px;'>" + area + "</font>";
                            }
                            String br="<br/>";
                            if(house.getHouseType() != null&&!house.getHouseType().equals("")  ){
//                                showInfo +="<br/><font style='font-size:20px;'>"+house.getHouseType()+"</font>&nbsp;&nbsp;";
                                br="";
                            }
                            if (!StringUtils.getNotNullInt(house.getStatus()).equals("2")) {
                                showInfo += br+"<input op='"+StringUtils.getNotNullString(house.getMemo())+"' style='' type='radio' title='" + house.getUnitNum() + "单元" + house.getBuildNum() + "号楼" + house.getHouseNum() + "房' name='hId' value='" + house.getId() + "'/>";
                            }
                        }

                        String houseStatus = "";
                        if (house != null) {
                            houseStatus = house.getStatus() + "";
                        }

                        DataDict colorDataDict = flagMap.get(houseStatus);
                        if (colorDataDict != null) {
                            bgColor = colorDataDict.getAttributeColor();
                        }

                        float width = 0;
                        if (temp1.size() > 0) {
                            width = 95 / maxSetNum / temp1.size();
                        } else {
                            width = 95 / maxSetNum;
                        }
            %>
            <td height="40" width="<%=width %>%" bgcolor="<%=bgColor%>"
                style="text-align:center;<%if(j==maxSetNum-1){%>border-left:#999999 0px solid;<%}%>
                        <%if(j==0){%>border-left:#999999 3px solid;<%}%>;">
                    <%--style="text-align:center;<%if(j==0){%>border-left:#999999 0px solid;<%}%>--%>
                    <%--<%if(j==maxSetNum-1){%>border-left:#999999 3px solid;<%}%>;">--%>
                <%=showInfo %>
            </td>
            <% }
                s++;
            }
            %>
        </tr>
        <%}%>
        <tr>
            <td bgcolor="#cccccc" height="35">
                <div class="out">
                    <span class="bm">楼层</span>
                    <span class="em">单元</span>
                </div>
            </td>
            <%

                int p = 0;
                //               for (int j = 0; j < temp1.size(); j++) {
                for (int j = temp1.size() - 1; j >= 0; j--){
                    String si = (String) temp1.get(j);
                    int t = setNum1[p];
                    if (t == 0) {
                        p++;
                        continue;
                    }
            %>
            <td height="25" colspan="<%=t%>" bgcolor="#BDBABD" align="center" style="border-left:#999999 1px solid; border-right:#999999 1px solid;"><%=si%>单元</td>
            <%
                    p++;
                }%>
        </tr>
    </table>
    <%
        }
    %>
    </div>
    <%--<div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">房屋状态操作</h4>
                </div>
                <div class="modal-body" id="myModalBoday">
                    <form id="inputForm" action="houseStatus" method="post">
                        <input type="hidden" name="houseId" id="houseId" value=""/>
                        <table class="table table-bordered table-striped">
                            <tbody>
                            <tr>
                                <td class="fieldName">房号</td>
                                <td class="text-left" id="number"></td>
                            </tr>
                            <tr>
                                <td class="fieldName">操作说明</td>
                                <td class="fieldValue">
                                    <input size="50%" type="text" name="opMemo" id="opMemoInfo" value="" />
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-success"  data-dismiss="modal" onclick="toSubmit(1)">标记未选</button>
                    <button type="button" class="btn btn-warning" data-dismiss="modal" onclick="toSubmit(3);">标记伪选</button>
                </div>
            </div>
        </div>
    </div>--%>

    <!------------------------------------房源弹框------------------------------------>
    <div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document" style="width: 900px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">房源信息</h4>
                </div>
                <div class="modal-body" id="myModalBoday">
                    <fieldset>
                        <%--<legend>房源信息</legend>--%>
                        <table class="table table-bordered">
                            <tbody>
                            <tr>
                                <td class="fieldName">项目名称</td>
                                <td class="fieldValue"> ${project.projectName} </td>
                                <td class="fieldName">楼号</td>
                                <td class="fieldValue"> ${house.buildNum} </td>
                            </tr>
                            <tr>
                                <td class="fieldName">单元</td>
                                <td class="fieldValue"> ${house.unitNum} </td>
                                <td class="fieldName">房号</td>
                                <td class="fieldValue"> ${house.houseNum} </td>
                            </tr>
                            <tr>
                                <td class="fieldName">居室</td>
                                <td class="fieldValue"> ${house.houseType} </td>
                                <td class="fieldName">建筑面积</td>
                                <td class="fieldValue"> ${house.buildArea} </td>
                            </tr>
                            <tr>
                                <td class="fieldName">申请编号</td>
                                <td class="fieldValue"> ${contract.familyCode} </td>
                                <td class="fieldName">合同编号</td>
                                <td class="fieldValue"> ${contract.contractCode} </td>
                            </tr>
                            <tr>
                                <td class="fieldName">产权人姓名</td>
                                <td class="fieldValue"> ${contract.name} </td>
                                <td class="fieldName">身份号码</td>
                                <td class="fieldValue"> ${contract.idCard} </td>
                            </tr>
                            <tr>
                                <td class="fieldName">合同签订日期</td>
                                <td class="fieldValue"> ${contract.signDate} </td>
                                <td class="fieldName">经办人</td>
                                <td class="fieldValue"> ${contract.person} </td>
                            </tr>
                            <tr>
                                <td class="fieldName">销售价格</td>
                                <td class="fieldValue"> ${contract.price} </td>
                                <td class="fieldName">产权比例</td>
                                <td class="fieldValue"> ${contract.propertyRight} </td>
                            </tr>
                            </tbody>
                        </table>
                    </fieldset>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

</c:if>
<script>
    $(function () {
        $("input[name='hId']").bind("click", function () {
            var num = $(this).attr("title");
            var a = $(this).attr("op");
            addOrEdit($(this).val(), num,a);
        });
    });

    $(function () {
        $("#excelBtn").click(function () {
            $("#dataTable tr td[flag='1']").css("background-color","#ffffff");
            $("#dataTable").table2excel({
                exclude: ".noExl",
                name: "${project.projectName}-${buildNum}号楼销控情况",
                filename: "${project.projectName}-${buildNum}号楼销控情况",
                exclude_img: false,
                exclude_links: false,
                exclude_inputs: false
            });
            $("#dataTable tr td[flag='1']").css("background-color","green");
        });
    });

    function unitShowOrHide(unitBtn){
        if(unitBtn==""){//显示全部
            $("#dataTable th[units],td[units]").show();
        }else{
            $("#dataTable th[units],td[units]").hide();
            $("#dataTable th[units='"+unitBtn+"'],td[units='"+unitBtn+"']").show();
        }
    }
    $(".unitShowOrHideBtn").click(function(){
        $(".unitShowOrHideBtn").removeClass("btn-danger").removeClass(" btn-warning").addClass(" btn-warning");
        $(this).addClass("btn-danger");
        unitShowOrHide($(this).attr("unitBtn"));
    });
</script>